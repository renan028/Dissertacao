\chapter{Arquitetura proposta}

O capítulo~\ref{bibliografia} apresentou os conceitos necessários para o
entendimento desta dissertação, mostrou a evolução das arquiteturas robóticas e
controles de missão, e as diversas aplicações em robôs modernos. A autonomia de
um robô depende, em grande parte, do desenvolvimento desta arquitetura robótica.

Neste capítulo, será apresentada uma implementação da arquitetura híbrida de
três camadas, utilizando o ambiente de desenvolvimento ROS, para um robô
móvel que executa tarefas de inspeção, a DORIS. Como definido no
capítulo~\ref{bibliografia}, a arquitetura robótica não é apenas uma
arquitetura de software, mas sim uma arquitetura que depende dos
componentes físicos do robô (hardware) e a sua aplicação. Dessa forma, faz-se
necessário apresentar o objeto de estudo desta dissertação.

\section{Robô DORIS}\label{doris}
DORIS é um robô desenvolvido pela COPPE/UFRJ, em colaboração com Petrobras e
Statoil, para aplicação \textit{offshore}: monitoramento e inspeção em
plataformas de petróleo. O robô é controlado de maneira autônoma ou teleoperado,
permitindo que o operador acompanhe o estado da missão, e monitore a informação
dos sensores. O robô apresenta as seguintes funcionalidades
\cite{carvalho2013doris}:

\begin{itemize}
  \item Detecção de anomalias por vídeo: uso de múltiplas câmeras (luz visível,
  infravermelho, fisheye e estéreo) para detectar anomalias, como objetos abandonados, fumaça,
  fogo, intrusos e vazamentos.
  \item Detecção de anomalias por áudio: microfones detectam áudios anômalos,
  como explosões, e realizam diagnóstico de mau funcionamento de máquinas, comparando os sons recebidos com
  assinaturas obtidas previamente.
  \item Detecção de anomalias por vibração: DORIS possui um manipulador com
  sensor de vibração em seu efetuador para inspecionar o funcionamento de máquinas, a partir de
  algoritmos com classificadores de falhas.
  \item Detecção de anomalias por sensor de gás: sensor de hidrocarboneto
  detecta o vazamento de gases.
  \item Mapeamento 3D do ambiente: DORIS é capaz de reconstruir um ambiente 3D a
  partir de câmeras e Laser.
  \item Detecção de anomalias por temperatura: DORIS possui um sensor de
  temperatura e umidade.
  \item Detecção de anomalias por câmera de infravermelho: uma câmera de
  infravermelho pode detectar pessoas, indicar a presença de intrusos ou
  indentificar incêncidos.
\end{itemize}

DORIS é um robô móvel que se locomove em um trilho pelo uso de dois gimbals, os
quais contêm atuadores e rodas. O robô foi desenvolvido dentro da filosofia
de modularidade, isto é, novos sensores podem ser integrados ao sistema, ou até
um novo módulo do robô pode ser adicionado, a fim de melhorar seu desempenho
dentro do escopo da aplicação de inspeção. Isso exige a
flexibilidade e modularidade do sistema mecânico, software e sistema
elétrico/eletrônico.

O sistema é alimentado por quatro baterias, composto por um computador
embarcado com processador de alto desempenho e memória, e um \textit{solid-state drive} para armazenamento. Possui
comunicações: Wireless IEEE 802.11n com a base (operador); \textit{Controller
Area Network} (CAN) entre computador embarcado e drivers dos atuadores; rede \textit{Local
Gigabit Ethernet} para os diversos componentes internos do robô; e rádio 2.4/5.0
GHz para emergência. Possui atuadores: quatro motores 200 W EC-4pole para
locomoção; e quatro motores para as juntas do mannipulador. Sensores:
câmera fixa; câmera térmica; câmera \textit{fisheye}; duas webcams; e uma
\textit{Inertial Measurement Unit} (IMU). Além disso, há um
sistema eletrônico de suporte de veículo, chamado \textit{Vehicle Support
System (VSS)} \cite{freitas2015embedded}, capaz de detectar falhas eletrônicas,
distribuir energia de maneira ótima entre os componentes e proteger o robô em
situações emergenciais.

O VSS possui funções que independem do software e da arquitetura robótica, são
considerados de alto risco e, portanto, não estão disponíveis para
programador e usuário. Em detalhes, as funções do VSS são:
\begin{itemize}
  \item Detecção de falhas: em dispositivos, pelo monitoramento de
  corrente/tensão; no módulo, pela verificação de temperatura/umidade;
  \item Proteção de dispositivos contra sobrecorrente graças a fusíveis;
  \item Distribuição ótima de energia e monitoramento de baterias;
  \item Botão de emergência para desligamento manual ou via rádio.
\end{itemize}

O trilho por onde o robô se desloca é construído a partir de tubos de
policloreto de polivinila (PVC) e possui seções retas, curvas ortogonais de
subida, descida, para a direita e para a esquerda. Os segmentos curvos são tubos
de 1 m dobrados $90^o$, resultando em curvaturas de aproximadamente 630 mm. Um
trilho para testes foi construído no Centro de Pesquisas e
Desenvolvimento da Petrobras (CENPES) e sua extensão é cerca de 140 m.

\section{A arquitetura robótica e o controle de missão implementados}

Na seção~\ref{doris}, foi apresentado o robô DORIS e suas funcionalidades. Como
foi definido na seção~\ref{conceitos}, pela visão do autor, o conceito de
\emph{arquitetura robótica} não é equivalente apenas a uma arquitetura de
software, necessitando da avaliação do robô como um todo, isto é, seus
elementos de hardware e sua aplicação. Assim como o desenvolvedor do RDE ROS
\cite{quigley2009ros} evidencia que não há melhor RDE, já que todos apresentam
vantagens e desvantagens e o melhor depende de sua aplicação, também não há
melhor arquitetura robótica, pois esta depende dos hardwares do robô e também da
sua aplicação.

DORIS é um robô móvel com a funcionalidade de inspeção em um ambiente não muito
dinâmico, usando técnicas que exigem grande processamento de imagem (câmeras) e
outros sensores. O usuário final poderá, com o auxílio de uma interface,
programar as missões: inspeção até uma posição do trilho, inspeção de
equipamento, ir até uma posição do trilho, e ronda (inspeção global). Além
disso, o usuário pode tomar o controle manual do robô, e visualizar as
respostas dos sensores.
 
As funcionalidades de inspeção do robô exigem a construção e manutenção do
modelo do mundo, pois há constante comparação com a situação esperada e
possíveis anomalias. Também fica claro que não é só um modelo do mundo que se
faz necessário, mas a construção de modelos distintos para cada componente
de forma a otimizar as missões. Além disso, robôs \textit{offshore} exigem
grande robustez, por trabalharem em ambientes hostis, e que demandam ações rápidas em situações
emergenciais. As exigências de um controle de missão para modos
flexíveis de inspeção, a manutenção de modelos de mundo e a robustez
no controle do robô demandam uma arquitetura híbrida.

No capítulo~\ref{bibliografia}, foi explicitada algumas formas de arquitetura
híbrida, mas aquela com maior número de aplicações bem sucedidas é a arquitetura
híbrida de três camadas, utilizadas desde a aplicação do carro autônomo do
desafio DARPA (Stanley) até a aplicação de exploração do robô da NASA no
planeta Marte. 

Escolhida a arquitetura híbrida de três camadas como arquitetura robótica da
DORIS, faz-se ainda necessário explicitar a implementação de cada camada, isto
é, como e qual executará as funções descritas por Murphy: sequenciador,
gerenciador de recurso, cartógrafo, planejador de missão, e monitor de
desempenho. A arquitetura de três camadas é formada por: camada Funcional,
camada Executiva e camada Planejador, e como cada arquitetura de três camadas
apresenta suas peculiaridades, as camadas desenvolvidas para o robô DORIS são descritas nas
subseções adiante.


\subsection{Camada Funcional}

A camada funcional é a primeira implementada e exaustivamente testada no
robô DORIS. Como nas outras arquiteturas de três camadas previamente
apresentadas, a camada Funcional é o nível mais baixo, conecta sensores a
atuadores, implementa controladores PID, e diversos outros algoritmos, por
exemplo para a localização do robô. Utiliza-se Ubuntu/Linux como sistema
operacional e ROS como RDE para a implementação do nível funcional, já que este
apresenta todas as vantagens descritas na subseção~\ref{ros}, e linguagem de programação C++, a fim de
se garantir maior eficiência computacional.

A camada funcional seguiu a recomendação dos desenvolvedores do ROS, sendo
estruturado de maneira semelhante à camada funcional do sistema CLARAty. Neste,
a camada funcional é uma interface com todo o sistema de hardware e suas
capacidades. É um software orientado a objeto, obtendo assim modularidade de
hardware, e uma estruturação apropriada para usar as propriedades de
herança, em software. A figura~\ref{claratyfunc} mostra a organização da camada
Funcional da arquitetura CLARAty.

\begin{figure}[!ht]
\centering
\includegraphics[width=.5\columnwidth]{figs/claratyfunc.jpg}
\caption{Organização da camada Funcional CLARAty}
\label{claratyfunc}
\end{figure}

Foi proposto o \textit{Robot Package Software}. Neste sistema,
\emph{Tools} (janelas gráficas) e \emph{Componentes} (unidades de comunicação e
processamento) são agrupados em \textit{Robot Package} (bibliotecas dinâmicas).
Os componentes que lidam com hardware rodam no computador embarcado do robô,
já os componentes que interagem com as \textit{tools} rodam no computador base.
Os diversos componentes, tanto do computador embarcado quanto da base, se
comunicam através de mensagens ROS, permitindo que a base controle o robô, na
função de teleoperação \cite{freitas2015embedded}. Os componentes do robô são
o foco de estudos desta dissertação, já que os componentes da base não estão
diretamente ligados à autonomia do robô, mas apenas a uma fração do controle de
missão, que diz respeito à interface com o usuário e \textit{feedback} dos
planos ao usuário.

Dois \textit{Robot Packages} fazem parte no desenvolvimento do robô DORIS:
\textit{General Package} e \textit{DORIS Package}, derivado do primeiro. Outros
robôs desenvolvidos por GSCAR, como o ROV LUMA, possuem seus pacotes
específicos, derivados do \textit{General Package}. 

O \textit{General Package} contém os componentes e \textit{tools} gerais
relacionados a vídeo, áudio, tabela de dados, \textit{gamepad} (para controle
remoto de robôs), e configurações de dispositivos que podem ser usados em outros
robôs

O \textit{DORIS Package} é um pacote mais específico ao robô DORIS e lida com
seus elementos de hardware e suas funcionalidades. Do ponto de vista de uma
arquitetura robótica, neste pacote foram implementados os \emph{comportamentos}
específicos do robô DORIS.  Os diversos componentes implementados para o DORIS
foram divididos em funcionalidades, neste trabalho, a fim de proporcionar melhor
entendimento.

Para a comunicação CAN
%Referenciar DFKI tb






\subsection{Camada planejador}
%TODO lembrar de mapa de equipamentos e quais precisam de manipulador
%TODO mapa de postes
%TODO mapa de distancias ao chao
%TODO mapa 3D
%TODO mapas analiticos
%TODO mapa das seções do trilho.
%TODO mapa audio
\subsection{Camada executiva}
%TODO falar das prioridades
%TODO recursos compartilhados, como fica?
